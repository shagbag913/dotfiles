#!/usr/bin/env dash

UTILS=$HOME/.bin/lemonbar_utils

# Check if the wrapper for this is compiled
if [ ! -f $UTILS ]; then
    make -C $HOME/.bin
fi

# Lemonbar colors
FOREGROUND="$($UTILS --get-pywal-color 15 '#FFFFFF')"
BACKGROUND="$($UTILS --get-pywal-color 0 '#000000')"

# Vertical size in percentage of the bar
BAR_HEIGHT_RATIO=04

# Find bspwm gap ratio
BSPWM_GAP=$(awk '/window_gap/{print $4}' $HOME/.config/bspwm/bspwmrc)
if [ $(echo $BSPWM | wc -l) -gt 1 ]; then BSPWM_GAP=0$BSPWM_GAP; fi

MONITOR_WIDTH=$(xrandr --query | grep ' connected' | grep -o '[0-9][0-9]\+' | sed -n 1p)
MONITOR_HEIGHT=$(xrandr --query | grep ' connected' | grep -o '[0-9][0-9]\+' | sed -n 2p)
BAR_WIDTH=$(echo "$MONITOR_WIDTH - $((BSPWM_GAP * 2))" | bc -l | sed 's/\..*//')
BAR_HEIGHT=$(echo "$MONITOR_HEIGHT * .$BAR_HEIGHT_RATIO" | bc -l | sed 's/\..*//')

$HOME/.bin/lemonbar_utils | lemonbar \
            -f 'Font Awesome 5 Free Solid:style=Solid' \
            -f 'SF Pro Display:style=Bold:size=10' \
            -g "$BAR_WIDTH"x"$BAR_HEIGHT"+"$BSPWM_GAP"+"$((BSPWM_GAP / 2))" \
            -B "$BACKGROUND" \
            -F "$FOREGROUND" \
            -b \
            -u 2 \
            -p | dash &

sleep 1
xdo above -t $(xdo id -n root) $(xdo id -n lemonbar)
