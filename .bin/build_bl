#!/usr/bin/env bash

# function to only notify if notifications are enabled
tg_notify() {
    [[ -z $NOTIFY ]] && return 0
    for i in $NOTIFY; do
        tg_bot -m "$1" -p "$i"
    done
}

while [[ $# -gt 1 ]]; do
    case $1 in
        -n|--notify)
            shift
            NOTIFY+=" $1"
            ;;
        -d|--device)
            shift
            DEVICE="$1"
            ;;
        -j|--jobs)
            shift
            JOBS="$1"
            ;;
        -m|--message)
            shift
            MESSAGE="$1"
            ;;
        -b|--build-type)
            shift
            BUILDTYPE="$1"
            ;;
    esac
shift
done

[[ -z $DEVICE ]] && DEVICE="sailfish"
[[ -z $JOBS ]] && JOBS="32"
[[ -z $BUILDTYPE ]] && BUILDTYPE="user"

. build/envsetup.sh
lunch bootleg_$DEVICE-$BUILDTYPE
BUILDTIME=$(elapsed)
tg_notify "BootleggersROM build for $DEVICE started"
make bacon -j$JOBS |& tee /tmp/build.log
BUILDSTATUS=${PIPESTATUS[0]}
if [[ $BUILDSTATUS = 141 ]]; then
    tg_notify "BootleggersROM build for $DEVICE aborted!%0A - Elapsed time: $(elapsed $BUILDTIME)"
elif [[ $BUILDSTATUS != 0 ]]; then
    for i in "FAILED" "ninja: error" "make:.*Stop."; do
        if [[ -n $(cat /tmp/build.log | sed -ne '/'"$i"'/,/\[ [0-9]/{ /\[ [0-9]/d; p }') ]]; then
            ERROR=$(cat /tmp/build.log | sed -ne '/'"$i"'/,/\[ [0-9]/{ /\[ [0-9]/d; p }')
        fi
    done
    DDLINK=$(deldog "$ERROR")
    if [[ -z $ERROR ]]; then
        tg_notify "BootleggersROM build for $DEVICE failed.%0A - Elapsed time: $(elapsed $BUILDTIME)"
    else
        tg_notify "BootleggersROM build for $DEVICE failed.%0A - Error: [del.dog]($DDLINK)%0A - Elapsed time: $(elapsed $BUILDTIME)"
    fi
    exit 1
else
    BUILDTIME=$(elapsed $BUILDTIME)
    UPLOADTIME=$(elapsed)
    BUILDZIP=$(ls out/target/product/$DEVICE/BootleggersROM*.zip | sort | tail -n 1)
    if gdrive upload --parent 1TZW9mUQus3nvMG90od3Y4zG7htdBOZw0 $BUILDZIP; then
        UPLOADTIME=$(elapsed $UPLOADTIME)
        tg_notify "$(echo "BootleggersROM build for $DEVICE successful!%0A" \
            "- Build time: $BUILDTIME%0A - Upload time: $UPLOADTIME%0A - Download: [gdrive]($(gdrive info \
            $(gdrive list --query "name contains 'Bootleggers'" --order "modifiedTime desc" -m 1 | tail -n 1 \
            | cut -d' ' -f 1) | sed -n 's/DownloadUrl: //p'))")"
    else
        tg_notify "$(echo "BootleggersROM build for $DEVICE successful!%0A" \
            "- Build time: $BUILDTIME%0A - Upload time: Upload failed!")"
    fi
fi
