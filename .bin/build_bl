#!/usr/bin/env bash

tg_bot "Starting BootleggersROM build for sailfish $1"
OLDTIME=$(elapsed)
rm /tmp/build.log
. build/envsetup.sh
lunch bootleg_sailfish-userdebug
make bacon -j30 |& tee /tmp/build.log
if [[ ${PIPESTATUS[0]} != 0 ]]; then
    for i in "FAILED" "ninja: error"; do
        if [[ $(cat /tmp/build.log | sed -ne '/'"$i"'/,$p') != "" ]]; then
            ERROR=$(cat /tmp/build.log | sed -ne '/'"$i"'/,$p')
        fi
    done
    DDLINK=$(deldog "$ERROR")
    if [[ -z $ERROR ]]; then
        tg_bot "BootleggersROM build for sailfish failed, @shagbag913."
    else
        tg_bot "BootleggersROM build for sailfish failed, @shagbag913. Error: $DDLINK"
    fi
    exit 1
else
    tg_bot "BootleggersROM build for sailfish successful in $(elapsed $OLDTIME)" 
    OLDTIME=$(elapsed)
    (
        cd out/target/product/sailfish
        cp $(ls BootleggersROM*.zip | sort | tail -n 1) $HOME/gdrive/Public/Bootleggers
    )
    if grive -p $HOME/gdrive; then
        tg_bot "BootleggersROM build for sailfish uploaded in $(elapsed $OLDTIME)."
    fi
fi
