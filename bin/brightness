#!/usr/bin/env bash
#
# Copyright (C) 2018 shagbag913
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#     http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# Script to control brightness and show a notification
# MUST HAVE 'notify-send.sh'(from aur) AND 'xbacklight' installed!
# This script also only works on INTEL graphics!
#
# Temp file to test whether the script is running or not
SCRIPT_TEMP="/tmp/brightness_script_running"
if [[ -f ${SCRIPT_TEMP} ]]; then
  exit 0
fi
touch /tmp/brightness_script_running

CURRENT_BRIGHTNESS=$( xbacklight )
CURRENT_BRIGHTNESS=${CURRENT_BRIGHTNESS%.*}

if [[ ${1} = "-inc" ]]; then
  xbacklight -inc 10
elif [[ ${1} = "-dec" ]] && [[ ${CURRENT_BRIGHTNESS} -ge "15" ]]; then
  xbacklight -dec 10
else
  xbacklight -set 5
fi

NEW_BRIGHTNESS=$( xbacklight )
NEW_BRIGHTNESS=${NEW_BRIGHTNESS%.*}

if [[ ${NEW_BRIGHTNESS} = "100" ]]; then
  NEW_BRIGHTNESS="Max"
elif [[ ${NEW_BRIGHTNESS} = "4" ]]; then
  NEW_BRIGHTNESS="Min"
else
  PERCENT="%"
fi

# determine which icon to use based on the brightness
if [[ ${NEW_BRIGHTNESS} -ge 80 ]] || [[ ${NEW_BRIGHTNESS} = "Max" ]]; then
  ICON=notification-display-brightness-full
elif [[ ${NEW_BRIGHTNESS} -ge 50 ]]; then
  ICON=notification-display-brightness-medium
elif [[ ${NEW_BRIGHTNESS} -gt 20 ]]; then
  ICON=notification-display-brightness-low
else
  ICON=notification-display-brightness-off
fi

notify-send.sh --icon=${ICON} -t 10 -R /tmp/brightness_notifyd_id \
    "Brightness: ${NEW_BRIGHTNESS}${PERCENT}"

rm ${SCRIPT_TEMP}
