#!/usr/bin/env bash
set -x
if [[ -f /tmp/volume_notif ]]; then
  exit
fi
touch /tmp/volume_notif

CURRENT_VOLUME=$(amixer -D pulse get Master|awk -F[][] '{print $2}' \
        |tr -d "\n"|sed -n 's/%.*//p')

if [[ ${CURRENT_VOLUME} -ge 80 ]]; then
  VOLUME_STEPS="1"
else
  VOLUME_STEPS="5"
fi

set_volume() {
  if [[ ${1} = -mute ]]; then
    amixer -D pulse sset Master toggle
    if amixer -D pulse get Master | grep off; then
      NEW_VOLUME="Muted"
    else
      NEW_VOLUME=$(amixer -D pulse get Master|awk -F[][] '{print $2}'\
              |tr -d "\n"|sed -n 's/%.*//p')
    fi
  else
    NEW_VOLUME=$(amixer -D pulse sset Master ${VOLUME_STEPS}%${1} \
            |awk -F[][] '{print $2}'|tr -d "\n"|sed -n 's/%.*//p')
  fi
}

if [[ ${1} = -mute ]]; then
  set_volume -mute
elif [[ ${1} = -inc ]]; then
  set_volume +
elif [[ ${1} = -dec ]]; then
  set_volume -
fi

if amixer -D pulse get Master | grep '\[off\]'; then
  MUTED=true
fi

if [[ -n ${MUTED} ]] || [[ ${NEW_VOLUME} = 0 ]]; then
  ICON=notification-audio-volume-muted.svg
elif [[ ${NEW_VOLUME} -le 33 ]]; then
  ICON=notification-audio-volume-low.svg
elif [[ ${NEW_VOLUME} -le 66 ]]; then
  ICON=notification-audio-volume-medium.svg
else
  ICON=notification-audio-volume-high.svg
fi

if [[ ${NEW_VOLUME} != "Muted" ]]; then
  NEW_VOLUME+=%
fi

if [[ ${MUTED} = true ]]; then
  NEW_VOLUME+=" (muted)"
fi

notify-send.sh --icon=/usr/share/icons/Numix/48/notifications/${ICON} \
        --app-name="Volume Script" -R /tmp/volume_libnotify "Volume: ${NEW_VOLUME}"

rm /tmp/volume_notif
