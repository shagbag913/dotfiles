#!/usr/bin/env bash

elapsed() {
    [[ -z $OLDTIME ]] && OLDTIME=$(cat /proc/uptime | sed -n 's/ .*//;s/\..*//p')
    NEWTIME=$(cat /proc/uptime | sed -n 's/ .*//;s/\..*//p')
    DIFFTIME=$((NEWTIME-OLDTIME))
    if [[ $DIFFTIME != 0 ]]; then
        unset DIFFTIME_TOTAL
        DIFFTIME_SEC=$((DIFFTIME % 60))
        DIFFTIME_MIN=$((DIFFTIME / 60 % 60))
        DIFFTIME_HOUR=$((DIFFTIME / 60 / 60 % 24))
	    if [[ $DIFFTIME_HOUR != 0 ]]; then
            DIFFTIME_TOTAL="${DIFFTIME_HOUR}h "
        fi
        if [[ $DIFFTIME_MIN != 0 ]]; then
            DIFFTIME_TOTAL+="${DIFFTIME_MIN}m "
        fi
        if [[ ${DIFFTIME_SEC} != 0 ]]; then
            DIFFTIME_TOTAL+="${DIFFTIME_SEC}s "
        fi
        echo "$DIFFTIME_TOTAL"
        unset OLDTIME NEWTIME
    fi
}

reposync() {
    time schedtool -B -n 1 -e ionice -n 1 repo sync -j$(($(nproc --all)*2-1)) --no-clone-bundle --prune --no-tags --quiet "$@"
}

grive() {
    if [[ $# = 0 ]]; then
        command grive -p /android/gdrive
        return
    else
        command grive "$@"
        return
    fi
}

build_bl() {
    . build/envsetup.sh
    tg_bot "Starting BootleggersROM build for sailfish $1"
    elapsed
    if ! brunch sailfish; then
        err "Bootleggers build failed!"
        tg_bot "BootleggersROM build for sailfish failed, @shagbag913"
        return 1
    fi
    (
        cd out/target/product/sailfish
        cp $(ls BootleggersROM*.zip | sort | tail -n 1) /android/gdrive/Public/Bootleggers
    )
    if grive -p /android/gdrive; then
        ELAPSED_TIME=$(elapsed)
        tg_bot "BootleggersROM build for sailfish successful! Built and uploaded in $ELAPSED_TIME."
    fi
}

temp_repo() {
    export TEMPREPO=https://github.com/shagbag913/temp-repo
    [[ -z $1 ]] && { echo "You must provide a branch name!"; return 1; }
    git push -f $TEMPREPO HEAD:$1
}

reinit_mouse() {
    sudo modprobe -r elan_i2c
    sudo modprobe elan_i2c
    sleep .5
    sudo xinput set-prop "Elan Touchpad" "libinput Middle Emulation Enabled" 1
    sudo xinput set-prop "Elan Touchpad" "libinput Natural Scrolling Enabled" 1
    sudo xinput set-prop "Elan Touchpad" "libinput Tapping Enabled" 1
}

rmul() {
    rsync -re "ssh -p$(sed -n 2p ${HOME}/.sshconf)" "$1" $(sed -n 1p ${HOME}/.sshconf):"$2"
}

rmdl() {
    rsync -re "ssh -p$(sed -n 2p ${HOME}/.sshconf)" $(sed -n 1p ${HOME}/.sshconf):"$1" "$2"
}
